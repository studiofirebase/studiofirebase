# üîß CORRE√á√ÉO - Sistema de Cadastro Facial de Administradores

**Data:** 10 de outubro de 2025  
**Problema:** Rosto n√£o est√° sendo cadastrado e enviado para o backend  
**Status:** ‚úÖ CORRIGIDO

---

## üîç An√°lise do Problema

### **Estrutura Existente no Firestore:**
```
firestore/
‚îú‚îÄ‚îÄ admin/                    ‚Üê Cole√ß√£o existente
‚îÇ   ‚îî‚îÄ‚îÄ profileSettings       ‚Üê Documento com configura√ß√µes do perfil
‚îî‚îÄ‚îÄ admins/                   ‚Üê Cole√ß√£o criada pelo sistema de face auth
    ‚îî‚îÄ‚îÄ {adminId}             ‚Üê Documentos de autentica√ß√£o
```

### **Problema Identificado:**

1. **Duas estruturas paralelas:**
   - Sistema existente usa `admin/profileSettings` (singular)
   - Sistema de face auth usa `admins/{adminId}` (plural)
   - Sem sincroniza√ß√£o entre as duas

2. **Dados faciais n√£o persistem:**
   - Captura facial funcionando ‚úÖ
   - Descritor e base64 sendo gerados ‚úÖ
   - Mas n√£o sendo salvos corretamente no Firestore ‚ùå

3. **Falta de integra√ß√£o:**
   - profileSettings n√£o tem refer√™ncia ao admin autenticado
   - Imposs√≠vel vincular configura√ß√µes do perfil com autentica√ß√£o facial

---

## ‚úÖ Solu√ß√£o Implementada

### **1. Estrutura Unificada**

Agora o sistema mant√©m **ambas as estruturas sincronizadas**:

```typescript
// Complete Registration API atualizada
await adminRef.set({
    id: adminRef.id,
    name,
    email,
    phone,
    faceData: {
        descriptor: faceData.descriptor,  // Array de 128 floats
        image: faceData.image,             // Base64 JPEG
        capturedAt: faceData.capturedAt,
        registeredAt: new Date().toISOString(),
    },
    role: 'admin',
    status: 'active',
    security: {
        faceAuthEnabled: true,
        emailVerified: true,
        phoneVerified: true,
    }
});

// Sincronizar com profileSettings existente
const profileSettingsRef = db.collection('admin').doc('profileSettings');
if (!profileSettingsSnap.exists) {
    // Criar profileSettings se n√£o existe
    await profileSettingsRef.set({
        name,
        email,
        phone,
        adminId: adminRef.id,  // ‚Üê VINCULAR ao admin autenticado
        faceAuthEnabled: true,
        // ... outros campos
    });
} else {
    // Atualizar refer√™ncia se j√° existe
    await profileSettingsRef.update({
        adminId: adminRef.id,
        faceAuthEnabled: true,
    });
}
```

### **2. Fluxo Completo do Cadastro**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 1: CAPTURA FACIAL                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Usu√°rio posiciona o rosto                               ‚îÇ
‚îÇ  2. face-api.js detecta rosto                               ‚îÇ
‚îÇ  3. Extrai 128-float descriptor                             ‚îÇ
‚îÇ  4. Canvas.toDataURL() gera base64 JPEG                     ‚îÇ
‚îÇ  5. Armazena em faceIdToken (JSON string)                   ‚îÇ
‚îÇ     {                                                         ‚îÇ
‚îÇ       descriptor: [128 floats],                             ‚îÇ
‚îÇ       image: "data:image/jpeg;base64,...",                  ‚îÇ
‚îÇ       capturedAt: "2025-10-10T..."                          ‚îÇ
‚îÇ     }                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 2: DADOS DO ADMINISTRADOR                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Nome completo                                           ‚îÇ
‚îÇ  2. Email                                                    ‚îÇ
‚îÇ  3. Telefone                                                ‚îÇ
‚îÇ  4. C√≥digo de convite                                       ‚îÇ
‚îÇ  5. POST /api/admin/auth/start-registration                 ‚îÇ
‚îÇ     ‚Üí Valida c√≥digo de convite                              ‚îÇ
‚îÇ     ‚Üí Cria pending_admin_registrations                      ‚îÇ
‚îÇ     ‚Üí Envia c√≥digos de verifica√ß√£o                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 3: VERIFICA√á√ÉO 2FA                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. C√≥digo de email (6 d√≠gitos)                             ‚îÇ
‚îÇ  2. C√≥digo de SMS (6 d√≠gitos)                               ‚îÇ
‚îÇ  3. POST /api/admin/auth/complete-registration              ‚îÇ
‚îÇ     ‚Üí Valida faceIdToken                                    ‚îÇ
‚îÇ     ‚Üí Verifica duplica√ß√£o facial (Euclidean distance)       ‚îÇ
‚îÇ     ‚Üí Valida c√≥digos de verifica√ß√£o                         ‚îÇ
‚îÇ     ‚Üí SALVA em admins/{id}                                  ‚îÇ
‚îÇ     ‚Üí SINCRONIZA com admin/profileSettings                  ‚îÇ
‚îÇ     ‚Üí Registra audit log                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  RESULTADO FINAL NO FIRESTORE                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  admins/{adminId}:                                          ‚îÇ
‚îÇ  {                                                           ‚îÇ
‚îÇ    id: "abc123",                                            ‚îÇ
‚îÇ    name: "Jo√£o Silva",                                      ‚îÇ
‚îÇ    email: "joao@example.com",                               ‚îÇ
‚îÇ    phone: "+5511999999999",                                 ‚îÇ
‚îÇ    faceData: {                                              ‚îÇ
‚îÇ      descriptor: [128 floats],        ‚Üê FACIAL RECOGNITION  ‚îÇ
‚îÇ      image: "data:image/jpeg...",     ‚Üê BASE64 IMAGE        ‚îÇ
‚îÇ      capturedAt: "2025-10-10...",                           ‚îÇ
‚îÇ      registeredAt: "2025-10-10..."                          ‚îÇ
‚îÇ    },                                                        ‚îÇ
‚îÇ    security: {                                              ‚îÇ
‚îÇ      faceAuthEnabled: true,                                 ‚îÇ
‚îÇ      emailVerified: true,                                   ‚îÇ
‚îÇ      phoneVerified: true                                    ‚îÇ
‚îÇ    }                                                         ‚îÇ
‚îÇ  }                                                           ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  admin/profileSettings:                                     ‚îÇ
‚îÇ  {                                                           ‚îÇ
‚îÇ    name: "Jo√£o Silva",                                      ‚îÇ
‚îÇ    email: "joao@example.com",                               ‚îÇ
‚îÇ    phone: "+5511999999999",                                 ‚îÇ
‚îÇ    adminId: "abc123",                  ‚Üê LINK TO AUTH       ‚îÇ
‚îÇ    faceAuthEnabled: true,                                   ‚îÇ
‚îÇ    profilePictureUrl: "...",                                ‚îÇ
‚îÇ    coverPhotoUrl: "...",                                    ‚îÇ
‚îÇ    // ... outras configura√ß√µes                              ‚îÇ
‚îÇ  }                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Como Testar

### **1. Limpar Dados Anteriores (Opcional)**

Se houver registros incompletos:

```javascript
// No Firebase Console > Firestore
// Deletar documentos de teste em:
// - admins (cole√ß√£o)
// - pending_admin_registrations (cole√ß√£o)
// - verification_codes (cole√ß√£o)
```

### **2. Iniciar Cadastro**

```bash
# Iniciar servidor
npm run dev

# Acessar
http://localhost:3000/admin

# Clicar em "Cadastre-se como Admin"
```

### **3. Etapa 1 - Captura Facial**

1. Permitir acesso √† c√¢mera
2. Posicionar o rosto na √°rea marcada
3. Aguardar detec√ß√£o (c√≠rculo verde)
4. Clicar em "Confirmar Registro"

**Verificar no Console do Navegador:**
```
[AdminRegistration] Face captured successfully
[AdminRegistration] Descriptor length: 128
[AdminRegistration] Image base64 length: ~45000
```

### **4. Etapa 2 - Dados do Admin**

Preencher:
- **Nome:** Jo√£o Silva
- **Email:** joao@example.com
- **Telefone:** +5511999999999
- **C√≥digo de Convite:** creatorsphere2025

**Verificar no Console do Backend:**
```
[Admin Registration] Iniciando registro...
[Admin Registration] Validando c√≥digo de convite...
[Admin Registration] ‚úÖ C√≥digo v√°lido
[Admin Registration] Enviando c√≥digos de verifica√ß√£o...
```

### **5. Etapa 3 - C√≥digos de Verifica√ß√£o**

**Verificar c√≥digos no Console do Backend:**
```
[Email Code] C√≥digo gerado: 123456
[SMS Code] C√≥digo gerado: 654321
```

Inserir c√≥digos e clicar em "Concluir Registro"

**Verificar sucesso:**
```
[Admin Registration] ‚úÖ Dados faciais validados com sucesso
[Admin Registration] Descriptor length: 128
[Admin Registration] Image size: 45 KB
[Admin Registration] Verificando se rosto j√° est√° cadastrado...
[Admin Registration] ‚úÖ Rosto √∫nico confirmado
[Admin Registration] ‚úÖ Administrador criado na cole√ß√£o admins: abc123
[Admin Registration] ‚úÖ ProfileSettings criado na cole√ß√£o admin
[Admin Registration] ‚úÖ Log de auditoria criado
========================================================
[Admin Registration] REGISTRO COMPLETO
========================================================
Admin ID: abc123
Nome: Jo√£o Silva
Email: joao@example.com
Telefone: +5511999999999
Face Auth: ‚úÖ Habilitado
2FA: ‚úÖ Habilitado
========================================================
```

### **6. Verificar no Firestore Console**

#### **admins/{adminId}:**
```json
{
  "id": "abc123",
  "name": "Jo√£o Silva",
  "email": "joao@example.com",
  "phone": "+5511999999999",
  "faceData": {
    "descriptor": [0.123, 0.456, ...],  // 128 n√∫meros
    "image": "data:image/jpeg;base64,/9j/4AAQ...",  // ~45KB
    "capturedAt": "2025-10-10T14:30:00.000Z",
    "registeredAt": "2025-10-10T14:30:05.000Z"
  },
  "security": {
    "faceAuthEnabled": true,
    "emailVerified": true,
    "phoneVerified": true,
    "registrationIP": "192.168.1.1",
    "userAgent": "Mozilla/5.0..."
  },
  "role": "admin",
  "status": "active",
  "createdAt": "2025-10-10T14:30:05.000Z",
  "twoFactorEnabled": true
}
```

#### **admin/profileSettings:**
```json
{
  "name": "Jo√£o Silva",
  "email": "joao@example.com",
  "phone": "+5511999999999",
  "adminId": "abc123",  // ‚Üê Refer√™ncia ao admin autenticado
  "faceAuthEnabled": true,
  "profilePictureUrl": "https://placeholder.co/150x150.png",
  "coverPhotoUrl": "https://placehold.co/1200x400.png",
  "galleryPhotos": [],
  "createdAt": "2025-10-10T14:30:05.000Z",
  "updatedAt": "2025-10-10T14:30:05.000Z"
}
```

#### **admin_audit_log/{logId}:**
```json
{
  "action": "admin_registered",
  "adminId": "abc123",
  "email": "joao@example.com",
  "timestamp": "2025-10-10T14:30:05.000Z",
  "metadata": {
    "name": "Jo√£o Silva",
    "phone": "+5511999999999",
    "faceAuthEnabled": true,
    "emailVerified": true,
    "phoneVerified": true,
    "registrationMethod": "face_id_with_2fa",
    "descriptorLength": 128,
    "imageSize": 45
  }
}
```

---

## üîê Testar Login Facial

Ap√≥s cadastro bem-sucedido, testar login:

### **1. Via API de Face Login**

```bash
# Capturar novo face descriptor do mesmo usu√°rio
# POST /api/admin/auth/face-login
{
  "faceIdToken": "{\"descriptor\":[...],\"image\":\"...\"}"
}

# Resposta esperada:
{
  "success": true,
  "admin": {
    "id": "abc123",
    "name": "Jo√£o Silva",
    "email": "joao@example.com",
    "faceAuthEnabled": true
  },
  "similarity": "95.42%",
  "loginMethod": "face_recognition"
}
```

### **2. Via Login Form (Email/Senha)**

Primeiro criar senha para o admin:

```bash
node scripts/create-secure-admin.js
# Usar o MESMO email do cadastro facial
# Criar uma senha forte
```

Depois testar login em `/admin`

---

## üìä Estrutura de Dados Completa

### **Collections Criadas:**

```
firestore/
‚îú‚îÄ‚îÄ admins/                           ‚Üê Autentica√ß√£o e face recognition
‚îÇ   ‚îî‚îÄ‚îÄ {adminId}/
‚îÇ       ‚îú‚îÄ‚îÄ id
‚îÇ       ‚îú‚îÄ‚îÄ name
‚îÇ       ‚îú‚îÄ‚îÄ email
‚îÇ       ‚îú‚îÄ‚îÄ phone
‚îÇ       ‚îú‚îÄ‚îÄ password (bcrypt hash)    ‚Üê Se usar email/senha
‚îÇ       ‚îú‚îÄ‚îÄ faceData/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ descriptor[]
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ image
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ capturedAt
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ registeredAt
‚îÇ       ‚îú‚îÄ‚îÄ security/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ faceAuthEnabled
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ emailVerified
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ phoneVerified
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ twoFactorEnabled
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ lastLoginAt
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ loginCount
‚îÇ       ‚îú‚îÄ‚îÄ role
‚îÇ       ‚îú‚îÄ‚îÄ status
‚îÇ       ‚îî‚îÄ‚îÄ createdAt
‚îÇ
‚îú‚îÄ‚îÄ admin/                            ‚Üê Configura√ß√µes do perfil
‚îÇ   ‚îî‚îÄ‚îÄ profileSettings/
‚îÇ       ‚îú‚îÄ‚îÄ name
‚îÇ       ‚îú‚îÄ‚îÄ email
‚îÇ       ‚îú‚îÄ‚îÄ phone
‚îÇ       ‚îú‚îÄ‚îÄ adminId                   ‚Üê LINK para admins/{id}
‚îÇ       ‚îú‚îÄ‚îÄ faceAuthEnabled
‚îÇ       ‚îú‚îÄ‚îÄ profilePictureUrl
‚îÇ       ‚îú‚îÄ‚îÄ coverPhotoUrl
‚îÇ       ‚îú‚îÄ‚îÄ galleryPhotos[]
‚îÇ       ‚îî‚îÄ‚îÄ ... (outras configs)
‚îÇ
‚îú‚îÄ‚îÄ pending_admin_registrations/      ‚Üê Registros tempor√°rios
‚îÇ   ‚îî‚îÄ‚îÄ {registrationId}/
‚îÇ       ‚îú‚îÄ‚îÄ email
‚îÇ       ‚îú‚îÄ‚îÄ name
‚îÇ       ‚îú‚îÄ‚îÄ phone
‚îÇ       ‚îú‚îÄ‚îÄ invitationCode
‚îÇ       ‚îú‚îÄ‚îÄ status
‚îÇ       ‚îú‚îÄ‚îÄ createdAt
‚îÇ       ‚îî‚îÄ‚îÄ expiresAt
‚îÇ
‚îú‚îÄ‚îÄ verification_codes/                ‚Üê C√≥digos 2FA tempor√°rios
‚îÇ   ‚îî‚îÄ‚îÄ {codeId}/
‚îÇ       ‚îú‚îÄ‚îÄ email/phone
‚îÇ       ‚îú‚îÄ‚îÄ code
‚îÇ       ‚îú‚îÄ‚îÄ type (email/sms)
‚îÇ       ‚îú‚îÄ‚îÄ used
‚îÇ       ‚îú‚îÄ‚îÄ createdAt
‚îÇ       ‚îî‚îÄ‚îÄ expiresAt
‚îÇ
‚îî‚îÄ‚îÄ admin_audit_log/                   ‚Üê Logs de auditoria
    ‚îî‚îÄ‚îÄ {logId}/
        ‚îú‚îÄ‚îÄ action
        ‚îú‚îÄ‚îÄ adminId
        ‚îú‚îÄ‚îÄ timestamp
        ‚îú‚îÄ‚îÄ ip
        ‚îú‚îÄ‚îÄ userAgent
        ‚îî‚îÄ‚îÄ metadata{}
```

---

## üö® Troubleshooting

### **Problema: "Dados faciais inv√°lidos"**

**Causa:** faceIdToken n√£o est√° sendo gerado corretamente

**Solu√ß√£o:**
1. Verificar console do navegador na Etapa 1
2. Confirmar que descriptor tem 128 floats
3. Confirmar que image est√° em formato base64

### **Problema: "Rosto j√° cadastrado"**

**Causa:** Descritor facial muito similar a admin existente

**Solu√ß√£o:**
1. Verificar se √© duplica√ß√£o leg√≠tima
2. Ajustar threshold em `face-comparison.ts` (padr√£o 0.6)
3. Deletar admin antigo se for teste

### **Problema: "C√≥digo de email/SMS inv√°lido"**

**Causa:** C√≥digos expiraram ou j√° foram usados

**Solu√ß√£o:**
1. Reiniciar processo de cadastro
2. Verificar logs do backend para c√≥digos gerados
3. Confirmar que c√≥digos n√£o expiraram (10 minutos)

### **Problema: profileSettings n√£o atualizado**

**Causa:** Admin criado mas profileSettings n√£o sincronizado

**Solu√ß√£o:**
Executar manualmente no Firestore Console:

```javascript
// No Firestore Console
// admin/profileSettings ‚Üí Adicionar campo
{
  "adminId": "abc123",  // ID do admin criado
  "faceAuthEnabled": true
}
```

---

## ‚úÖ Checklist de Verifica√ß√£o

- [ ] Credenciais hardcoded removidas do frontend
- [ ] bcryptjs instalado (`npm install bcryptjs @types/bcryptjs`)
- [ ] Firestore rules deployed
- [ ] Firestore indexes deployed
- [ ] Schema documents criados
- [ ] Face-api.js models carregados
- [ ] C√¢mera funcionando no navegador
- [ ] Captura facial gerando descriptor + base64
- [ ] C√≥digos de verifica√ß√£o sendo enviados
- [ ] Admin sendo criado em `admins/`
- [ ] profileSettings sendo sincronizado em `admin/`
- [ ] Audit log sendo registrado
- [ ] Face login funcionando
- [ ] Email/senha login funcionando (opcional)

---

## üìö Documenta√ß√£o Relacionada

- `/docs/ADMIN_FACE_REGISTRATION_SYSTEM.md` - Sistema completo de face recognition
- `/docs/BACKEND_SETUP_GUIDE.md` - Guia de configura√ß√£o do backend
- `/docs/SECURITY_FIX_EXPOSED_CREDENTIALS.md` - Corre√ß√£o de seguran√ßa
- `/src/lib/face-comparison.ts` - Biblioteca de compara√ß√£o facial
- `/src/app/api/admin/auth/complete-registration/route.ts` - API de registro
- `/src/app/api/admin/auth/face-login/route.ts` - API de login facial
- `/src/app/api/admin/auth/login/route.ts` - API de login email/senha

---

**Sistema agora est√° completamente integrado e funcional! üéâ**
